<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Document</title>
    <script
      src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.x.x/dist/alpine.min.js"
      defer
    ></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>

    <style>
      .bar {
        fill: dodgerblue;
      }
    </style>
  </head>

  <body>
    <div x-data="app()">
      <header>
        <h1>pomo-done-o</h1>
      </header>

      <section class="countdown">
        <p x-show="!isDone" x-text="remaining"></p>
      </section>

      <section class="actions">
        <button x-show="!isRunning" @click="start()">Start</button>
        <button x-show="isRunning" @click="stop()">Stop</button>
      </section>

      <section x-show="isDone" class="summary">
        <div>
          <h2>How was it</h2>

          <select x-model="emotion">
            <option value=""></option>
            <option value="great">great</option>
            <option value="good">good</option>
            <option value="tired">tired</option>
            <option value="frustrting">frustrating</option>
            <option value="distracted">distracted</option>
          </select>
        </div>

        <button @click="save()">Save</button>
      </section>

      <section>
        <div id="chart"></div>

        <table>
          <thead>
            <tr>
              <th>start</th>
              <th>end</th>
              <th>how was it?</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="p in pomodoros">
              <tr>
                <td x-text="formatDate(p.startDate)"></td>
                <td x-text="formatDate(p.endDate)"></td>
                <td x-text="p.emotion"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </section>
    </div>

    <script>
      function app() {
        const rawData = localStorage.getItem('data');
        const pomodoros = rawData ? JSON.parse(rawData) : [];

        drawChart(pomodoros);

        return {
          startDate: undefined,
          endDarte: undefined,
          emotion: '',
          remaining: '25:00',
          isRunning: false,
          isDone: false,
          pomodoros,

          start() {
            this.startDate = new Date();
            this.endDate = new Date(this.startDate.getTime() + 1500000); // 25 min in milliseconds
            this.emotion = '';

            this.isRunning = true;
            this.tick();
          },

          stop() {
            this.endDate = new Date();
          },

          save() {
            this.pomodoros.push({
              startDate: this.startDate.getTime(),
              endDate: this.endDate.getTime(),
              emotion: this.emotion,
            });

            this.isDone = false;
            this.remaining = '25:00';

            localStorage.setItem('data', JSON.stringify(this.pomodoros));
          },

          tick() {
            setTimeout(() => {
              const now = Date.now();
              const diffMs = this.endDate.getTime() - now;

              if (diffMs <= 0) {
                this.isRunning = false;
                this.isDone = true;
                return;
              }

              const diff = new Date(diffMs);

              const displayMin = diff.getMinutes();
              const displaySec = diff.getSeconds();

              this.remaining = `${displayMin}:${displaySec}`;

              this.tick();
            }, 200);
          },

          formatDate(raw) {
            const date = new Date(raw);

            return `${date.toDateString()} ${date.toTimeString()}`;
          },
        };
      }

      function drawChart(data) {
        console.log(data);

        const margin = {top: 20, right: 20, bottom: 30, left: 40},
          width = 960 - margin.left - margin.right,
          height = 500 - margin.top - margin.bottom;

        const x = d3
          .scaleBand()
          .range([0, width])
          .padding(0.1);

        const y = d3.scaleLinear().range([height, 0]);

        console.log(margin);
        console.log(height);

        const svg = d3
          .select('#chart')
          .append('svg')
          .attr('width', width + margin.left + margin.right)
          .attr('height', height + margin.top + margin.bottom)
          .append('g')
          .attr(
            'transform',
            'translate(' + margin.left + ',' + margin.top + ')',
          );

        x.domain(data.map((d, i) => i));

        y.domain([
          d3.min(data, d => d.startDate),
          d3.max(data, d => d.endDate),
        ]);

        const y1 = y(data[0].startDate);
        const y2 = y(data[0].endDate);
        console.log(y1, y2, y1 - y2);

        svg
          .selectAll('.bar')
          .data(data)
          .enter()
          .append('rect')
          .attr('class', 'bar')
          .attr('x', (d, i) => x(i))
          .attr('width', x.bandwidth())
          .attr('y', d => y(d.startDate))
          .attr('height', d => y(d.startDate) - y(d.endDate));

        // add the x Axis
        svg
          .append('g')
          .attr('transform', 'translate(0,' + height + ')')
          .call(d3.axisBottom(x));

        // add the y Axis
        svg.append('g').call(d3.axisLeft(y));
      }
    </script>
  </body>
</html>
